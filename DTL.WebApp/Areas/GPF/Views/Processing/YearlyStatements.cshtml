@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Yearly Statements";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container-fluid view_form">
    <div class="row header_section mx-0 px-0">
        <div class="col-6 position-relative ps-0">
            <span class="btn btn-light float-start mt-1 me-2 d-block d-md-none" id="menu_toggle">
                <i class="fa-solid fa-bars"></i>
            </span>
            <h3 class="mb-0"></h3>
        </div>
        <p class="mb-0 col-6 top_link_Section">
            <a href="@Url.Action("Dashboard","Processing", new { Area="GPF" })">Dashboard</a>
            <span class="px-1">/</span>
            <a href="@Url.Action("StatementForm","Processing", new { Area="GPF" })">Statement Form</a>
            <span class="px-1">/</span><span>Yearly Statements</span>
        </p>
    </div>


    <div class="card border-card  mt-0" id="dMain">
        <div class="card-body">
            <div class="text-center">
                <h4><span name="org"></span></h4>
                <p class="subtitle">Annual Statement (<span name="fy"></span>)</p>
            </div>
            <div class="table-responsive mt-4">
                <table class="table table-bordered">
                    <tr>
                        <th>GPF No</th>
                        <td><span name="accountNo"></span></td>
                        <th>Name</th>
                        <td><span name="name"></span></td>
                        <th>Year</th>
                        <td><span name="year"></span></td>
                    </tr>
                    <tr>

                        <th>Emp  Id</th>
                        <td><span name="email"></span></td>
                        <th>Father / Husband Name</th>
                        <td><span name="fatherName"></span></td>
                        <th>DOB</th>
                        <td><span name="dob"></span></td>
                    </tr>
                    <tr>

                        <th>Joining Date</th>
                        <td colspan="5"><span name="doj"></span></td>

                    </tr>
                </table>
                <table id="table" class="table table-bordered ">

                    <thead>
                        <tr>

                            <th colspan="2">Opening Balance</th>

                            <th colspan="6"><span name="opening"></span> <span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th class="text-left">Month-Year </th>
                            <th class="text-center">GPF Contribution</th>
                            <th class="text-center">Refundable Advance</th>
                            <th class="text-center">Advance Refund</th>
                            <th class="text-center">Interest Rate </th>
                            <th class="text-center">Interest Amt </th>
                            <th class="text-center">Non Refundable Advance</th>
                            <th class="text-right">Total Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        @*<tr>

                            <td class="text-left">Apr-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                            <td class="text-center">7.1% </td>
                            <td class="text-center">142<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">65765<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">May-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                            <td class="text-center">8%</td>
                            <td class="text-center">169<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">May-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                            <td class="text-center">8%</td>
                            <td class="text-center">169<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">Jun-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center">5000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center">7.1%</td>
                            <td class="text-center">142<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">July-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center">1000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center">7.1%</td>
                            <td class="text-center">142<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>*@



                        <tr>
                            <th class="text-center"><strong>Total</strong> </th>
                            <th class="text-center"><strong><span class="sum deposit"></span><span class="text-danger req_text">&#8377; </span></strong></th>
                            <th class="text-center"></th>
                            <th class="text-center"><strong><span class="sum advanceRefund"></span><span class="text-danger req_text">&#8377; </span></strong></th>
                            <th class="text-center"> </th>
                            <th class="text-center"><strong><span class="sum interest"></span><span class="text-danger req_text">&#8377; </span> </strong></th>
                            <th class="text-center"></th>
                            <th class="text-right"><strong><span class="sum total"></span><span class="text-danger req_text">&#8377; </span></strong></th>
                        </tr>
                        <tr>
                            <td colspan="5" rowspan="6"></td>
                            <th>Opening Balance</th>
                            <th></th>
                            <th class="text-right"><span name="opening"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th>Total Deposit</th>
                            <th></th>
                            <th class="text-right"><span name="totalDeposit"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th>Total Interest</th>
                            <th></th>
                            <th class="text-right"><span name="totalInterest"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th>Total</th>
                            <th></th>
                            <th class="text-right"><span name="totalAmount"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th>Withdrawl</th>
                            <th></th>
                            <th class="text-right"><span name="totalWithdrawal"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th>Current Balance</th>
                            <th></th>
                            <th class="text-right"><span name="currentBalance"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>

                    </tbody>

                </table>


            </div>
            <div class="row mb-3 submit_area submit_area_strip mt-5 mx-0">

                <div class="col-sm-12">
                    <button class="btn btn-primary" id="printMe">
                        <i class="fa fa-print mr-2"
                           aria-hidden="true"></i>Print Application
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<template id="tmplRow">
    <tr>
        <td class="text-left"><span name="month"></span></td>
        <td class="text-center"><span name="deposit"></span><span class="text-danger req_text">&#8377; </span></td>
        <td class="text-center"><span name="refundableAdvance"></span></td>
        <td class="text-center"><span name="advanceRefund"></span></td>
        <td class="text-center"><span name="interestRate"></span></td>
        <td class="text-center"><span name="interest"></span><span class="text-danger req_text">&#8377; </span></td>
        <td class="text-center"><span name="nonRefundable"></span></td>
        <td class="text-right"><span name="total"></span><span class="text-danger req_text">&#8377; </span></td>
    </tr>
</template>

<div id="print_preview">
    <div class=" view_container_bg mt-0">
        <div class="card-body">
            <div class="text-center">
                <h4><span name="org"></span></h4>
                <p class="subtitle">Annual Statement (<span name="fy"></span>)</p>
            </div>
            <div class="table-responsive mt-4">
                <table class="table table-bordered">
                    <tr>
                        <th>GPF No</th>
                        <td><span name="accountNo"></span></td>
                        <th>Name</th>
                        <td><span name="name"></span></td>
                        <th>Year</th>
                        <td><span name="year"></span></td>
                    </tr>
                    <tr>

                        <th>Emp  Id</th>
                        <td><span name="email"></span></td>
                        <th>Father / Husband Name</th>
                        <td><span name="fatherName"></span></td>
                        <th>DOB</th>
                        <td><span name="dob"></span></td>
                    </tr>
                    <tr>

                        <th>Joining Date</th>
                        <td colspan="5"><span name="doj"></span></td>

                    </tr>
                </table>
                <table id="table" class="table table-bordered ">

                    <thead>
                        <tr>

                            <th colspan="2">Opening Balance</th>

                            <th colspan="6"><span name="opening"></span> <span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th class="text-left">Month-Year </th>
                            <th class="text-center">GPF Contribution</th>
                            <th class="text-center">Refundable Advance</th>
                            <th class="text-center">Advance Refund</th>
                            <th class="text-center">Interest Rate </th>
                            <th class="text-center">Interest Amt </th>
                            <th class="text-center">Non Refundable Advance</th>
                            <th class="text-right">Total Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                       @* <tr>

                            <td class="text-left">Apr-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                            <td class="text-center">7.1% </td>
                            <td class="text-center">142<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">65765<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">May-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                            <td class="text-center">8%</td>
                            <td class="text-center">169<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">May-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center"></td>
                            <td class="text-center">8%</td>
                            <td class="text-center">169<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">Jun-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center">5000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center">7.1%</td>
                            <td class="text-center">142<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>
                        <tr>

                            <td class="text-left">July-2000 </td>
                            <td class="text-center">2000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-center">1000<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center">7.1%</td>
                            <td class="text-center">142<span class="text-danger req_text">&#8377; </span></td>
                            <td class="text-center"></td>
                            <td class="text-right">655<span class="text-danger req_text">&#8377; </span></td>
                        </tr>*@



                        <tr>
                            <th class="text-center"><strong>Total</strong> </th>
                            <th class="text-center"><strong><span class="sum deposit"></span><span class="text-danger req_text">&#8377; </span></strong></th>
                            <th class="text-center"></th>
                            <th class="text-center"><strong><span class="sum advanceRefund"></span><span class="text-danger req_text">&#8377; </span></strong></th>
                            <th class="text-center"> </th>
                            <th class="text-center"><strong><span class="sum interest"></span><span class="text-danger req_text">&#8377; </span> </strong></th>
                            <th class="text-center"></th>
                            <th class="text-right"><strong><span class="sum total"></span><span class="text-danger req_text">&#8377; </span></strong></th>
                        </tr>
                        <tr>
                            <td colspan="4" rowspan="6"></td>
                            <th colspan="2">Opening Balance</th>
                            <th></th>
                            <th class="text-right"><span name="opening"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th colspan="2">Total Deposit</th>
                            <th></th>
                            <th class="text-right"><span name="totalDeposit"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th colspan="2">Total Interest</th>
                            <th></th>
                            <th class="text-right"><span name="totalInterest"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th colspan="2">Total</th>
                            <th></th>
                            <th class="text-right"><span name="totalAmount"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th colspan="2">Withdrawl</th>
                            <th></th>
                            <th class="text-right"><span name="totalWithdrawal"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>
                        <tr>

                            <th colspan="2">Current Balance</th>
                            <th></th>
                            <th class="text-right"><span name="currentBalance"></span><span class="text-danger req_text">&#8377; </span></th>
                        </tr>

                    </tbody>

                </table>


            </div>

        </div>
    </div>

</div>
<script>
    $('#printMe').click(function () {
        $('#print_preview').addClass('show');
        window.print();
    });

    $(document).ready(function () {
        $.get(`@Url.Action("GetStatement", "Data")?orgCode=${encodeURIComponent('@ViewBag.OrgCode')}&accNo=${encodeURIComponent('@ViewBag.AccountNumber')}&year=${'@ViewBag.FY'}`).then(r => {
            if (r) {
                const el = name => $('#dMain,#print_preview').find(`[name="${name}"]`)
                const sum = col => r.monthlyData.map(q => q[col]).reduce((a, b) => a + b) || 0;

                el('org').text(r.organisation);
                el('fy').text(r.financialYear);
                el('accountNo').text(r.accountNo);
                el('name').text(r.employeeName);
                el('email').text(r.employeeCode);
                el('fatherName').text(r.fatherName);
                el('year').text(@ViewBag.FY);
                el('doj').text(moment(r.doj).format('DD-MMM-YYYY'));
                el('dob').text(moment(r.dob).format('DD-MMM-YYYY'));
                el('opening').text(r.opening.toFixed(2));
                el('totalDeposit').text(sum('memberContribution').toFixed(2));
                el('totalInterest').text(sum('memberInterest').toFixed(2));
                el('totalAmount').text(sum('gpfAmount').toFixed(2));
                el('totalWithdrawal').text(sum('0').toFixed(2));
                el('currentBalance').text(r.gpfBalance.toFixed(2));
                var arr = [], deposit = 0, advanceRefund = 0, interest = 0, total = 0;
                for (i = 0; i < 12; i++) {
                    var month = moment(new Date(parseInt(@ViewBag.FY) - 1, 3, 1)).add(i, 'month');
                    var tr = $($('#tmplRow').html());
                    var dt = r.monthlyData.filter(q => moment(new Date(q.year, q.month - 1, 1)).format('YYYY-MM-DD') == month.format('YYYY-MM-DD'));
                    var sum1 = col => dt.length ? dt.map(q => q[col]).reduce((a, b) => a + b) || 0 : 0;

                    $(tr).find('[name="month"]').text(month.format("MMM-YYYY"));
                    $(tr).find('[name="deposit"]').text(sum1('memberContribution').toFixed(2));
                    $(tr).find('[name="refundableAdvance"]').text(sum1('refundableAdvance').toFixed(2));
                    $(tr).find('[name="advanceRefund"]').text(sum1('advanceRefund').toFixed(2));
                    $(tr).find('[name="interestRate"]').text((sum1('memberInterest') * 100 / sum1('memberContribution')).toFixed(2));
                    $(tr).find('[name="interest"]').text(sum1('memberInterest').toFixed(2));
                    $(tr).find('[name="nonRefundable"]').text(sum1('nonRefundable').toFixed(2));
                    $(tr).find('[name="total"]').text((sum1('memberInterest') + sum1('memberContribution')).toFixed(2));
                    deposit += sum1('memberContribution');
                    advanceRefund += sum1('advanceRefund');
                    interest += sum1('memberInterest');
                    total += sum1('memberInterest') + sum1('memberContribution');

                    if (dt.length) arr.push(tr);
                }
                $('#dMain,#print_preview').find('#table').find('tbody').prepend(arr);
                $('#dMain,#print_preview').find('#table').find('.sum.deposit').text(deposit.toFixed(2));
                $('#dMain,#print_preview').find('#table').find('.sum.advanceRefund').text(advanceRefund.toFixed(2));
                $('#dMain,#print_preview').find('#table').find('.sum.interest').text(interest.toFixed(2));
                $('#dMain,#print_preview').find('#table').find('.sum.total').text(total.toFixed(2));

                //$('#dMain').show();
            }
        });
    })

</script>